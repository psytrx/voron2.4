[gcode_macro PRINT_START]
gcode:
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set target_chamber = params.CHAMBER|default("40")|int %}

  # set safe probing temps without waiting
  M104 S150 ; hotend
  M140 S120 ; bed

  CG28

  G90 ; absolute positioning
  G0 X150 Y150 Z15 F9000

  {% set heat_soak_chamber = target_bed > 90 and printer['temperature_sensor chamber'].temperature < target_chamber %}

  {% if heat_soak_chamber %}
    { action_respond_info("Heat-soaking chamber to %dÂ°C" % (target_chamber)) }

    M140 S{target_bed}
    M106 S255 ; part cooling fan at full blast
    START_FILTER SPEED=0.5 ; nevermore to circulate air

    G90 ; absolute positioning
    G0 X{x_wait} Y{y_wait} Z15 F9000
    TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber}
  {% endif %}

  BED_MESH_CLEAR

  G28 Z
  QUAD_GANTRY_LEVEL
  BED_MESH_CALIBRATE ADAPTIVE=1

  { action_respond_info("Heating up extruder to %dÂ°C" % (target_extruder)) }
  
  G90 ; absolute positioning
  G0 X150 Y150 Z15 F9000
  M109 S{target_extruder}

  { action_respond_info("Purging the nozzle") }

  G90 ; absolute positioning
  G0 X100 Y5 F9000
  G0 Z0.4
  G91 ; relative positioning
  G1 X100 E20 F1000
  G90 ; absolute positioning
